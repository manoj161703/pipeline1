# ===============================================================
#  Streamlit Web App - Azure DevOps CI/CD Pipeline
#  Builds Docker image, pushes to ACR, and deploys on VM
# ===============================================================

trigger:
  branches:
    include:
      - main

pool:
  name: 'Default'   # Your self-hosted VM agent pool name

variables:
  acrLoginServer: 'acr12.azurecr.io'    # Replace with your ACR login server
  imageName: 'pipeline1-app'            # Image name inside ACR
  containerName: 'pipeline1_app'        # Container name on VM
  hostPort: '8503'                      # Port exposed on VM
  containerPort: '8501'                 # Streamlit default port (inside container)

stages:
  # -------------------------------------------------------------
  #  STAGE 1: Build & Push Docker Image
  # -------------------------------------------------------------
  - stage: BuildAndPush
    displayName: 'Build and Push Docker Image to ACR'
    jobs:
      - job: Build
        displayName: 'Build & Push Image'
        steps:
          - checkout: self

          - script: |
              set -euo pipefail
              echo "Logging in to Azure Container Registry..."
              echo "$(acrPassword)" | docker login $(acrLoginServer) -u "$(acrUsername)" --password-stdin
              echo "✅ Login successful"

              echo "Building Docker image..."
              docker build -t $(acrLoginServer)/$(imageName):$(Build.BuildId) \
                           -t $(acrLoginServer)/$(imageName):latest .

              echo "Pushing image to ACR..."
              docker push $(acrLoginServer)/$(imageName):$(Build.BuildId)
              docker push $(acrLoginServer)/$(imageName):latest
            displayName: 'Docker Build and Push'

  # -------------------------------------------------------------
  #  STAGE 2: Deploy Docker Container on VM
  # -------------------------------------------------------------
  - stage: Deploy
    displayName: 'Deploy Latest Docker Image on VM'
    dependsOn: BuildAndPush
    jobs:
      - job: DeployJob
        displayName: 'Deploy to VM'
        steps:
          - script: |
              set -euo pipefail
              echo "Logging in to Azure Container Registry..."
              echo "$(acrPassword)" | docker login $(acrLoginServer) -u "$(acrUsername)" --password-stdin
              echo "✅ Login successful (Deploy stage)"

              echo "Pulling latest image..."
              docker pull $(acrLoginServer)/$(imageName):latest

              echo "Removing old container if exists..."
              docker rm -f $(containerName) || true

              echo "Starting new container..."
              docker run -d -p $(hostPort):$(containerPort) \
                         --name $(containerName) \
                         $(acrLoginServer)/$(imageName):latest

              echo "✅ Deployment completed successfully!"
              echo "Currently running containers:"
              docker ps
            displayName: 'Deploy Container on VM'
