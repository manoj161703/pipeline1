trigger:
  branches:
    include:
      - main   # run pipeline when you push to main

# Use your self-hosted agent on the VM
pool:
  name: 'Default'

variables:
  acrName: 'acr12'
  acrLoginServer: 'acr12.azurecr.io'
  acrRepo: 'pipeline1-app'         # image name in ACR

stages:
  - stage: BuildAndPush
    displayName: Build and push Docker image to ACR
    jobs:
      - job: Build
        displayName: Build and push image
        steps:
          - checkout: self

          - task: Docker@2
            displayName: Build and push to ACR
            inputs:
              command: buildAndPush
              containerRegistry: 'acr12-service-connection'   # ACR service connection name
              repository: '$(acrRepo)'
              dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
              tags: |
                latest
                $(Build.BuildId)

  - stage: DeployToVM
    displayName: Deploy image on VM
    dependsOn: BuildAndPush
    jobs:
      - job: Deploy
        displayName: Run container on VM
        steps:
          - script: |
              echo "Logging in to ACR..."
              sudo docker login $(acrLoginServer) -u $(acrUsername) -p $(acrPassword)

              echo "Pulling latest image..."
              sudo docker pull $(acrLoginServer)/$(acrRepo):latest

              echo "Stopping old container (if it exists)..."
              sudo docker rm -f pipeline1_app || true

              echo "Starting new container..."
              sudo docker run -d \
                -p 8503:8501 \
                --name pipeline1_app \
                $(acrLoginServer)/$(acrRepo):latest

              echo "Deployment complete."
            displayName: 'Pull & restart Docker container'
