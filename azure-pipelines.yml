# ===============================================================
#  Streamlit Web App - Azure DevOps CI/CD Pipeline
# ===============================================================

trigger:
  branches:
    include:
      - main

# Use your self-hosted agent pool
pool:
  name: 'Default'

variables:
  acrLoginServer: 'acr12.azurecr.io'
  imageName: 'pipeline1-app'
  containerName: 'pipeline1_app'
  hostPort: '8503'
  containerPort: '8501'

stages:
  # -------------------------------------------------------------
  #  STAGE 1: Build & Push on YOUR VM (self-hosted)
  # -------------------------------------------------------------
  - stage: BuildAndPush
    displayName: 'Build and Push Docker Image to ACR'
    jobs:
      - job: Build
        displayName: 'Build & Push Image'
        steps:
          - checkout: self

          - script: |
              set -euo pipefail
              set -x

              echo "Logging in to Azure Container Registry: $(acrLoginServer)"

              echo "$(acrPassword)" | docker login $(acrLoginServer) \
                -u "$(acrUsername)" --password-stdin

              echo "✅ Docker login succeeded"

              echo "Building Docker image..."
              docker build \
                -t $(acrLoginServer)/$(imageName):$(Build.BuildId) \
                -t $(acrLoginServer)/$(imageName):latest .

              echo "Pushing image to ACR..."
              docker push $(acrLoginServer)/$(imageName):$(Build.BuildId)
              docker push $(acrLoginServer)/$(imageName):latest
            displayName: 'Docker Build and Push'

  # -------------------------------------------------------------
  #  STAGE 2: Deploy on the same VM
  # -------------------------------------------------------------
  - stage: Deploy
    displayName: 'Deploy Latest Image on VM'
    dependsOn: BuildAndPush
    jobs:
      - job: DeployJob
        displayName: 'Deploy Container on VM'
        steps:
          - script: |
              set -euo pipefail
              set -x

              echo "Logging in to Azure Container Registry: $(acrLoginServer)"

              echo "$(acrPassword)" | docker login $(acrLoginServer) \
                -u "$(acrUsername)" --password-stdin

              echo "✅ Docker login succeeded (Deploy stage)"

              echo "Pulling latest Docker image..."
              docker pull $(acrLoginServer)/$(imageName):latest

              echo "Stopping old container if it exists..."
              docker stop $(containerName) || true

              echo "Removing old container if it exists..."
              docker rm $(containerName) || true

              echo "Starting new container..."
              docker run -d \
                -p $(hostPort):$(containerPort) \
                --name $(containerName) \
                $(acrLoginServer)/$(imageName):latest

              echo "Deployment completed successfully!"
              echo "Currently running containers:"
              docker ps
            displayName: 'Pull and Restart Docker Container'
