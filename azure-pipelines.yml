trigger:
  branches:
    include:
      - main   # run pipeline when you push to main

pool:
  vmImage: 'ubuntu-latest'

variables:
  acrName: 'acr12'
  acrRepo: 'pipeline1-app'
  acrLoginServer: 'acr12.azurecr.io'
  vmHost: '172.191.37.116'

stages:
  - stage: BuildAndPush
    displayName: Build and push Docker image to ACR
    jobs:
      - job: Build
        displayName: Build image
        steps:
          - checkout: self

          - task: Docker@2
            displayName: Build and push image
            inputs:
              command: buildAndPush
              containerRegistry: 'acr12-service-connection'   # service connection to ACR
              repository: '$(acrRepo)'
              dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
              tags: |
                latest
                $(Build.BuildId)

  - stage: DeployToVM
    displayName: Deploy image to Azure VM
    dependsOn: BuildAndPush
    jobs:
      - job: Deploy
        displayName: Deploy on VM
        steps:
          - task: SSH@0
            displayName: Deploy to VM via SSH
            inputs:
              sshEndpoint: 'vm-ssh-connection'   # service connection to your VM
              runOptions: 'commands'
              commands: |
                # Log in to ACR from inside the VM
                sudo docker login $(acrLoginServer) -u $(acrUsername) -p $(acrPassword)

                # Pull the latest image
                sudo docker pull $(acrLoginServer)/$(acrRepo):latest

                # Stop & remove any old container
                sudo docker rm -f pipeline1_app || true

                # Run updated container on host port 8503 -> container 8501
                sudo docker run -d \
                  -p 8503:8501 \
                  --name pipeline1_app \
                  $(acrLoginServer)/$(acrRepo):latest
